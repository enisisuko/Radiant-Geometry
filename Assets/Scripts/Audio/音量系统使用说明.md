# 全局音量系统使用说明

## 🎵 系统概述

这是一个完整的全局音量控制系统，可以统一管理整个游戏项目的所有音频。

### 主要功能
- ✅ 全局主音量控制
- ✅ 自动保存/加载音量设置
- ✅ 静音切换功能
- ✅ UI滑块控制
- ✅ 百分比显示
- ✅ 跨场景保持
- ✅ 单例模式访问

---

## 📂 文件结构

```
Assets/Scripts/Audio/
├── GlobalAudioManager.cs        # 全局音量管理器（核心）
└── 音量系统使用说明.md          # 本文档

Assets/Scripts/UI/MENU/
└── VolumeControlUI.cs           # 音量控制UI组件
```

---

## 🚀 快速开始

### 步骤1：添加GlobalAudioManager到场景

**方法A：自动创建（推荐）** ✨
- 系统会在第一次调用时自动创建GlobalAudioManager
- 无需手动添加
- 自动设置DontDestroyOnLoad

**方法B：手动创建**
1. 在主菜单场景创建空物体，命名为"GlobalAudioManager"
2. 添加`GlobalAudioManager.cs`组件
3. 该对象会自动设置为DontDestroyOnLoad，跨场景保持

### 步骤2：在主菜单添加音量控制UI

#### 2.1 创建完整UI结构（推荐）

在主菜单Canvas下创建如下结构：

```
Canvas
└── SettingsPanel (Panel)
    ├── Background (Image) - 半透明黑色背景
    ├── PanelContent (Panel) - 设置内容面板
    │   ├── Title (Text) - "游戏设置"
    │   ├── CloseButton (Button) - "X" 或 "关闭"
    │   │
    │   ├── VolumeSection (Panel)
    │   │   ├── VolumeTitle (Text) - "音量设置"
    │   │   ├── VolumeSlider (Slider) - 音量滑块
    │   │   │   ├── Background
    │   │   │   ├── Fill Area
    │   │   │   │   └── Fill
    │   │   │   └── Handle Slide Area
    │   │   │       └── Handle
    │   │   ├── VolumePercent (Text) - 显示"100%"
    │   │   └── MuteButton (Button) - 静音按钮
    │   │       ├── Icon (Image)
    │   │       └── Text - "静音"
    │   │
    │   └── Buttons (Panel)
    │       ├── ApplyButton (Button) - "应用"
    │       └── ResetButton (Button) - "重置"
    │
    └── (SettingsPanelManager.cs) - 添加到SettingsPanel
        └── (VolumeControlUI.cs) - 添加到VolumeSection
```

#### 2.2 配置滑块

选中VolumeSlider，在Inspector中设置：
- **Min Value**: 0
- **Max Value**: 1
- **Whole Numbers**: 取消勾选
- **Value**: 1

#### 2.3 添加SettingsPanelManager组件

1. 选中SettingsPanel
2. 添加`SettingsPanelManager.cs`组件
3. 配置引用：
   - **Panel Root**: 拖拽SettingsPanel自己
   - **Canvas Group**: 会自动添加
   - **Close Button**: 拖拽CloseButton
   - **Apply Button**: 拖拽ApplyButton（可选）
   - **Reset Button**: 拖拽ResetButton（可选）
   - **Volume Control**: 拖拽VolumeSection上的VolumeControlUI组件

#### 2.4 添加VolumeControlUI组件

1. 选中VolumeSection
2. 添加`VolumeControlUI.cs`组件
3. 配置引用：
   - **Volume Slider**: 拖拽VolumeSlider
   - **Volume Percent Text**: 拖拽VolumePercent文本
   - **Mute Button**: 拖拽MuteButton按钮
   - **Mute Button Image**: 拖拽MuteButton的Icon图片

#### 2.5 集成到主菜单

**方法A：ColorfulMainMenu（五分区菜单）**
1. 打开主菜单场景
2. 选中ColorfulMainMenu对象
3. 在Inspector中找到Settings Panel字段
4. 拖拽SettingsPanel到该字段
5. 菜单会自动扩展为6个分区（新增"设置"选项）

**方法B：MainMenu（简单菜单）**
1. 选中MainMenu对象
2. 在Inspector中找到Settings Panel字段
3. 拖拽SettingsPanel到该字段
4. 在菜单按钮上调用`MainMenu.OpenSettings()`方法

#### 2.6 可选：设置音效和图标

- **Normal Volume Icon**: 正常音量图标（🔊）
- **Muted Volume Icon**: 静音图标（🔇）
- **Open Sound**: 打开设置面板音效
- **Close Sound**: 关闭设置面板音效
- **Apply Sound**: 应用设置音效

---

## 💻 代码使用示例

### 基础用法

```csharp
using FadedDreams.Audio;

// 设置主音量（0-1）
GlobalAudioManager.SetMasterVolume(0.5f);

// 获取当前音量
float volume = GlobalAudioManager.GetMasterVolume();

// 静音切换
GlobalAudioManager.Mute();

// 检查是否静音
bool isMuted = GlobalAudioManager.Instance.IsMuted();

// 重置音量为默认值（1.0）
GlobalAudioManager.Instance.ResetVolume();
```

### 高级用法

```csharp
// 设置音量并立即保存
GlobalAudioManager.Instance.SetVolumeAndSave(0.75f);

// 手动保存当前音量
GlobalAudioManager.Instance.SaveVolume();

// 手动加载保存的音量
GlobalAudioManager.Instance.LoadVolume();

// 访问音量属性
float currentVolume = GlobalAudioManager.Instance.MasterVolume;
GlobalAudioManager.Instance.MasterVolume = 0.8f; // 设置但不保存
```

---

## 🎨 UI定制

### 修改显示格式

在VolumeControlUI组件中：

```csharp
// 显示整数百分比（例如：75%）
Show Percent Sign: ✓
Percent Format: "0"

// 显示小数百分比（例如：75.5%）
Show Percent Sign: ✓
Percent Format: "0.0"

// 仅显示数字（例如：75）
Show Percent Sign: ☐
Percent Format: "0"
```

### 添加音效反馈

在VolumeControlUI组件中：

1. **Volume Change Sound**: 拖拽滑块调整时的音效
2. **Mute Toggle Sound**: 拖拽静音切换时的音效
3. **Sound Volume**: 调整音效音量（0-1）

---

## 🔧 系统集成

### 与现有音频系统集成

全局音量系统通过控制`AudioListener.volume`工作，因此会影响所有音频：

```csharp
// 所有这些都会受主音量影响：
AudioSource.PlayOneShot(clip);
AudioSource.Play();
// 背景音乐
// UI音效
// 游戏音效
```

### 多场景使用

GlobalAudioManager使用DontDestroyOnLoad，会自动在场景间保持：

```csharp
// 场景A
GlobalAudioManager.SetMasterVolume(0.5f);

// 切换到场景B后
// 音量设置仍然保持为0.5
```

---

## 📊 PlayerPrefs设置

音量设置保存在PlayerPrefs中：

- **键名**: "MasterVolume"
- **值类型**: float (0.0 - 1.0)
- **自动保存**: ✓
- **自动加载**: ✓

### 清除保存的设置

```csharp
// 代码方式
PlayerPrefs.DeleteKey("MasterVolume");

// 或使用重置功能
GlobalAudioManager.Instance.ResetVolume();
```

---

## 🐛 故障排除

### 问题1：音量没有保存

**解决方案**：
- 确保调用了`SaveVolume()`或`SetVolumeAndSave()`
- 检查是否有权限写入PlayerPrefs

### 问题2：UI滑块不工作

**解决方案**：
- 检查VolumeControlUI组件的引用是否正确配置
- 确保Slider的Min Value=0, Max Value=1
- 查看Console是否有错误信息

### 问题3：跨场景音量丢失

**解决方案**：
- 确保GlobalAudioManager已设置DontDestroyOnLoad
- 检查是否在新场景中创建了多个实例

### 问题4：音效不响应音量变化

**解决方案**：
- 确保AudioSource没有设置"Ignore Listener Volume"
- 检查AudioListener是否存在且活跃

---

## 🎯 最佳实践

1. **在主菜单初始化**
   - GlobalAudioManager会在第一次访问时自动创建
   - 建议在主菜单场景显式创建

2. **使用UI控制**
   - 推荐使用VolumeControlUI组件
   - 提供直观的用户体验

3. **自动保存**
   - 使用`SetVolumeAndSave()`代替直接设置属性
   - 确保用户设置被持久化

4. **音效反馈**
   - 为音量调整添加适当的音效反馈
   - 提升用户体验

---

## 📝 完整示例场景

### 主菜单设置示例

```
MainMenu场景
├── GlobalAudioManager (DontDestroyOnLoad)
│   └── GlobalAudioManager.cs
│
└── Canvas
    ├── MainMenu（现有菜单）
    │   ├── 新游戏按钮
    │   ├── 继续游戏按钮
    │   └── ...
    │
    └── SettingsPanel
        └── VolumeControl
            ├── VolumeControlUI.cs
            ├── Title: "音量设置"
            ├── Slider (0-1)
            ├── Percent: "100%"
            └── MuteButton
```

---

## 🎁 额外功能

### 调试功能

在编辑器中，GlobalAudioManager提供右键菜单：
- 测试：设置音量为50%
- 测试：静音切换
- 测试：重置音量

### 详细日志

启用"Verbose Logs"查看详细调试信息：
```
[GlobalAudioManager] 初始化成功
[GlobalAudioManager] 音量已加载: 0.75
[GlobalAudioManager] 主音量设置为: 0.50
[GlobalAudioManager] 音量已保存: 0.50
```

---

## 💡 技术细节

### 单例模式
- 使用懒加载单例模式
- 线程不安全（Unity主线程）
- DontDestroyOnLoad保持跨场景

### 音量控制原理
```csharp
// Unity的全局音量控制
AudioListener.volume = masterVolume; // 0.0 - 1.0
```

### 保存机制
```csharp
// 使用PlayerPrefs持久化
PlayerPrefs.SetFloat("MasterVolume", volume);
PlayerPrefs.Save(); // 立即写入磁盘
```

---

## 📞 支持与反馈

如果遇到问题或有改进建议，请联系开发团队！

爱娘祝素素使用愉快~ (｡♥‿♥｡)

